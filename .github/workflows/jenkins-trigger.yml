# Jenkins Trigger - Reusable Workflow
# Triggers Jenkins jobs for unit tests and/or Docker builds
#
# Reads pyproject.toml from the repo to determine:
#   - Odoo version
#   - Whether to run fast tests (fast_tests = true)
#   - Whether to build Docker (build_docker = true)
#   - Odoo edition (enterprise/community)
#
# Behavior:
#   - fast_tests controls unit test execution (default: true)
#   - build_docker controls Docker build on deploy branches (default: false)
#   - If both are false, Jenkins is skipped entirely
#
# Usage:
#   - On PR: triggers unit tests only (if fast_tests=true)
#   - On push to deploy branch: triggers tests and/or deploy based on flags

name: Trigger Jenkins

on:
  workflow_call:
    inputs:
      deploy-branches:
        description: 'Branches that trigger deploy (comma-separated, e.g., "main,production")'
        required: false
        type: string
        default: 'main'
      dry-run:
        description: 'If true, log but do not trigger Jenkins'
        required: false
        type: boolean
        default: false
    secrets:
      JENKINS_URL:
        required: false
      JENKINS_USER:
        required: false
      JENKINS_TOKEN:
        required: false
    outputs:
      triggered:
        description: 'Whether Jenkins was triggered'
        value: ${{ jobs.trigger.outputs.triggered }}
      skipped:
        description: 'Whether Jenkins was skipped (no tests, no deploy)'
        value: ${{ jobs.trigger.outputs.skipped }}
      odoo-version:
        description: 'Odoo version from pyproject.toml'
        value: ${{ jobs.trigger.outputs.odoo-version }}
      build-docker:
        description: 'Whether Docker build is enabled'
        value: ${{ jobs.trigger.outputs.build-docker }}
      fast-tests:
        description: 'Whether fast tests are enabled'
        value: ${{ jobs.trigger.outputs.fast-tests }}

jobs:
  trigger:
    name: Jenkins
    runs-on: ubuntu-latest
    outputs:
      triggered: ${{ steps.trigger.outputs.triggered }}
      skipped: ${{ steps.mode.outputs.skip }}
      odoo-version: ${{ steps.config.outputs.odoo-version }}
      build-docker: ${{ steps.config.outputs.build-docker }}
      fast-tests: ${{ steps.config.outputs.fast-tests }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            pyproject.toml
          sparse-checkout-cone-mode: false

      - name: Read pyproject.toml
        id: config
        run: |
          echo "::group::Reading pyproject.toml"

          if [ ! -f pyproject.toml ]; then
            echo "::warning::pyproject.toml not found - using defaults"
            echo "odoo-version=17" >> $GITHUB_OUTPUT
            echo "build-docker=false" >> $GITHUB_OUTPUT
            echo "fast-tests=true" >> $GITHUB_OUTPUT
            echo "odoo-edition=enterprise" >> $GITHUB_OUTPUT
            echo "git-hosts=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse [odoo] section from pyproject.toml
          # Using grep/sed for simplicity (no external dependencies)

          # Extract odoo.version (e.g., 17.0 -> 17)
          ODOO_VERSION=$(grep -E "^version\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g; s/\.0$//')
          if [ -z "$ODOO_VERSION" ]; then
            ODOO_VERSION="17"
          fi
          echo "odoo-version=$ODOO_VERSION" >> $GITHUB_OUTPUT
          echo "Odoo Version: $ODOO_VERSION"

          # Extract build_docker (true/false, default: false)
          BUILD_DOCKER=$(grep -E "^build_docker\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          if [ "$BUILD_DOCKER" != "true" ]; then
            BUILD_DOCKER="false"
          fi
          echo "build-docker=$BUILD_DOCKER" >> $GITHUB_OUTPUT
          echo "Build Docker: $BUILD_DOCKER"

          # Extract fast_tests (true/false, default: true)
          FAST_TESTS=$(grep -E "^fast_tests\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          if [ "$FAST_TESTS" != "false" ]; then
            FAST_TESTS="true"
          fi
          echo "fast-tests=$FAST_TESTS" >> $GITHUB_OUTPUT
          echo "Fast Tests: $FAST_TESTS"

          # Extract edition (enterprise/community)
          ODOO_EDITION=$(grep -E "^edition\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          if [ -z "$ODOO_EDITION" ]; then
            ODOO_EDITION="enterprise"
          fi
          echo "odoo-edition=$ODOO_EDITION" >> $GITHUB_OUTPUT
          echo "Odoo Edition: $ODOO_EDITION"

          # Extract git_hosts (optional)
          GIT_HOSTS=$(grep -E "^git_hosts\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          echo "git-hosts=$GIT_HOSTS" >> $GITHUB_OUTPUT
          echo "Git Hosts: $GIT_HOSTS"

          echo "::endgroup::"

      - name: Determine deploy mode
        id: mode
        run: |
          # Get config values
          FAST_TESTS="${{ steps.config.outputs.fast-tests }}"
          BUILD_DOCKER="${{ steps.config.outputs.build-docker }}"
          IS_PUSH="${{ github.event_name == 'push' }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          DEPLOY_BRANCHES="${{ inputs.deploy-branches }}"

          # Check if current branch is in deploy-branches list
          IS_DEPLOY_BRANCH="false"
          IFS=',' read -ra BRANCHES <<< "$DEPLOY_BRANCHES"
          for branch in "${BRANCHES[@]}"; do
            branch=$(echo "$branch" | xargs)  # trim whitespace
            if [ "$CURRENT_BRANCH" == "$branch" ]; then
              IS_DEPLOY_BRANCH="true"
              break
            fi
          done

          echo "Event: ${{ github.event_name }}"
          echo "Current Branch: $CURRENT_BRANCH"
          echo "Deploy Branches: $DEPLOY_BRANCHES"
          echo "Is Deploy Branch: $IS_DEPLOY_BRANCH"
          echo "Fast Tests: $FAST_TESTS"
          echo "Build Docker: $BUILD_DOCKER"

          # Skip Jenkins entirely if nothing to do
          if [ "$FAST_TESTS" == "false" ] && [ "$BUILD_DOCKER" == "false" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "mode=Skipped (no tests, no deploy configured)" >> $GITHUB_OUTPUT
            echo "::notice::Skipping Jenkins - both fast_tests and build_docker are false"
            exit 0
          fi

          # PRs never deploy, only run tests (if enabled)
          if [ "$IS_PUSH" != "true" ]; then
            if [ "$FAST_TESTS" == "true" ]; then
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "deploy=false" >> $GITHUB_OUTPUT
              echo "mode=Unit Tests Only" >> $GITHUB_OUTPUT
            else
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "deploy=false" >> $GITHUB_OUTPUT
              echo "mode=Skipped (fast_tests=false for PR)" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Push events - determine mode based on branch and flags
          DEPLOY="false"
          if [ "$IS_DEPLOY_BRANCH" == "true" ] && [ "$BUILD_DOCKER" == "true" ]; then
            DEPLOY="true"
          fi

          # Determine final mode
          if [ "$FAST_TESTS" == "true" ] && [ "$DEPLOY" == "true" ]; then
            MODE="Unit Tests + Docker Build"
          elif [ "$FAST_TESTS" == "true" ]; then
            MODE="Unit Tests Only"
          elif [ "$DEPLOY" == "true" ]; then
            MODE="Docker Build Only"
          else
            # Non-deploy branch with fast_tests=false
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "mode=Skipped (fast_tests=false, not a deploy branch)" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
          echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "Will deploy: $DEPLOY"
          echo "Mode: $MODE"

      - name: Skip Jenkins (nothing to do)
        if: steps.mode.outputs.skip == 'true'
        run: |
          echo "## Jenkins Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration from pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fast Tests | \`${{ steps.config.outputs.fast-tests }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker | \`${{ steps.config.outputs.build-docker }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":information_source: No Jenkins job was triggered." >> $GITHUB_STEP_SUMMARY

      - name: Validate Jenkins configuration
        id: validate
        if: steps.mode.outputs.skip != 'true'
        run: |
          if [ -z "${{ secrets.JENKINS_URL }}" ]; then
            echo "::warning::JENKINS_URL not configured - running in dry-run mode"
            echo "dry-run=true" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.dry-run }}" == "true" ]; then
            echo "Dry-run mode enabled"
            echo "dry-run=true" >> $GITHUB_OUTPUT
          else
            echo "dry-run=false" >> $GITHUB_OUTPUT
          fi

      - name: Log Jenkins trigger (dry-run)
        if: steps.mode.outputs.skip != 'true' && steps.validate.outputs.dry-run == 'true'
        run: |
          echo "## Jenkins Trigger (Dry Run)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration from pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | \`${{ steps.config.outputs.odoo-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Fast Tests | \`${{ steps.config.outputs.fast-tests }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker | \`${{ steps.config.outputs.build-docker }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Edition | \`${{ steps.config.outputs.odoo-edition }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trigger Parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | \`${{ steps.mode.outputs.deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Branches | \`${{ inputs.deploy-branches }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":information_source: Dry-run mode - Jenkins was not triggered." >> $GITHUB_STEP_SUMMARY

          echo "::notice::Dry-run: Would trigger Jenkins (${{ steps.mode.outputs.mode }}) for ${{ github.repository }}@${{ github.ref_name }}"

      - name: Trigger Jenkins
        id: trigger
        if: steps.mode.outputs.skip != 'true' && steps.validate.outputs.dry-run == 'false'
        run: |
          echo "Triggering Jenkins: ${{ steps.mode.outputs.mode }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Deploy: ${{ steps.mode.outputs.deploy }}"
          echo "  Fast Tests: ${{ steps.config.outputs.fast-tests }}"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ secrets.JENKINS_URL }}/generic-webhook-trigger/invoke" \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n '${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}' | base64)" \
            -d '{
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "odoo_version": "${{ steps.config.outputs.odoo-version }}",
              "odoo_edition": "${{ steps.config.outputs.odoo-edition }}",
              "git_hosts": "${{ steps.config.outputs.git-hosts }}",
              "deploy": ${{ steps.mode.outputs.deploy }},
              "build_docker": ${{ steps.config.outputs.build-docker }},
              "fast_tests": ${{ steps.config.outputs.fast-tests }},
              "github_run_id": "${{ github.run_id }}",
              "github_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "event": "${{ github.event_name }}",
              "pr_number": "${{ github.event.pull_request.number || '' }}"
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" != "200" && "$HTTP_CODE" != "201" ]]; then
            echo "::error::Jenkins trigger failed with HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

          echo "triggered=true" >> $GITHUB_OUTPUT

          echo "## Jenkins Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration from pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | \`${{ steps.config.outputs.odoo-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Fast Tests | \`${{ steps.config.outputs.fast-tests }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker | \`${{ steps.config.outputs.build-docker }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Edition | \`${{ steps.config.outputs.odoo-edition }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trigger Parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | \`${{ steps.mode.outputs.deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":rocket: Jenkins job started!" >> $GITHUB_STEP_SUMMARY

          echo "::notice::Jenkins triggered (${{ steps.mode.outputs.mode }}) for ${{ github.repository }}@${{ github.ref_name }}"
