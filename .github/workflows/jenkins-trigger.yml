# Jenkins Trigger - Reusable Workflow
# Triggers Jenkins jobs for Docker builds and deployments
#
# Reads pyproject.toml from the repo to determine:
#   - Odoo version
#   - Whether to build Docker (build_docker = true)
#   - Odoo edition (enterprise/community)
#   - [deploy] section for deploy requirements
#
# Behavior:
#   - Docker builds only trigger on push to deploy branches with build_docker=true
#   - PRs do NOT trigger Jenkins (tests run in GitHub Actions via odoo-tests.yml)
#   - Supports wildcard patterns in deploy-branches (e.g., staging-* matches staging-dev-foo)
#   - Can skip CI stages in Jenkins (quality checks already done in GitHub Actions)
#
# Usage:
#   - On PR: does nothing (tests handled by odoo-tests.yml)
#   - On push to deploy branch: triggers Docker build (if build_docker=true)
#
# Cost Efficiency:
#   - When skip-ci-in-jenkins=true, Jenkins skips QA stages (already done in GitHub Actions)
#   - This avoids running quality checks and tests twice
#
# Note: Concurrency should be set in the calling workflow, not here.
# This allows the caller to define the concurrency group based on their context.

name: Trigger Jenkins

on:
  workflow_call:
    # Note: Concurrency should be set in the calling workflow, not here
    # This allows the caller to define the concurrency group based on their context
    inputs:
      deploy-branches:
        description: 'Branch patterns that trigger deploy (comma-separated, supports wildcards e.g., "main,staging-*")'
        required: false
        type: string
        default: 'main'
      dry-run:
        description: 'If true, log but do not trigger Jenkins'
        required: false
        type: boolean
        default: false
      skip-ci-in-jenkins:
        description: 'Tell Jenkins to skip QA stages (already done in GitHub Actions). Cost-efficient.'
        required: false
        type: boolean
        default: true
    secrets:
      JENKINS_URL:
        required: false
      JENKINS_USER:
        required: false
      JENKINS_TOKEN:
        required: false
    outputs:
      triggered:
        description: 'Whether Jenkins was triggered'
        value: ${{ jobs.trigger.outputs.triggered }}
      odoo-version:
        description: 'Odoo version from pyproject.toml'
        value: ${{ jobs.trigger.outputs.odoo-version }}
      build-docker:
        description: 'Whether Docker build is enabled'
        value: ${{ jobs.trigger.outputs.build-docker }}
      skip-ci:
        description: 'Whether Jenkins was told to skip CI stages'
        value: ${{ jobs.trigger.outputs.skip-ci }}

jobs:
  trigger:
    name: Jenkins
    runs-on: ubuntu-latest
    outputs:
      triggered: ${{ steps.trigger.outputs.triggered }}
      odoo-version: ${{ steps.config.outputs.odoo-version }}
      build-docker: ${{ steps.config.outputs.build-docker }}
      skip-ci: ${{ inputs.skip-ci-in-jenkins }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            pyproject.toml
          sparse-checkout-cone-mode: false

      - name: Read pyproject.toml
        id: config
        run: |
          echo "::group::Reading pyproject.toml"

          if [ ! -f pyproject.toml ]; then
            echo "::warning::pyproject.toml not found - using defaults"
            echo "odoo-version=17" >> $GITHUB_OUTPUT
            echo "build-docker=false" >> $GITHUB_OUTPUT
            echo "odoo-edition=enterprise" >> $GITHUB_OUTPUT
            echo "git-hosts=" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse [odoo] section from pyproject.toml
          # Using grep/sed for simplicity (no external dependencies)

          # Extract odoo.version (e.g., 17.0 -> 17)
          ODOO_VERSION=$(grep -E "^version\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g; s/\.0$//')
          if [ -z "$ODOO_VERSION" ]; then
            ODOO_VERSION="17"
          fi
          echo "odoo-version=$ODOO_VERSION" >> $GITHUB_OUTPUT
          echo "Odoo Version: $ODOO_VERSION"

          # Extract build_docker (true/false, default: false)
          BUILD_DOCKER=$(grep -E "^build_docker\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          if [ "$BUILD_DOCKER" != "true" ]; then
            BUILD_DOCKER="false"
          fi
          echo "build-docker=$BUILD_DOCKER" >> $GITHUB_OUTPUT
          echo "Build Docker: $BUILD_DOCKER"

          # Extract edition (enterprise/community)
          ODOO_EDITION=$(grep -E "^edition\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          if [ -z "$ODOO_EDITION" ]; then
            ODOO_EDITION="enterprise"
          fi
          echo "odoo-edition=$ODOO_EDITION" >> $GITHUB_OUTPUT
          echo "Odoo Edition: $ODOO_EDITION"

          # Extract git_hosts (optional)
          GIT_HOSTS=$(grep -E "^git_hosts\s*=" pyproject.toml | head -1 | sed 's/.*=\s*//; s/[" ]//g')
          echo "git-hosts=$GIT_HOSTS" >> $GITHUB_OUTPUT
          echo "Git Hosts: $GIT_HOSTS"

          echo "::endgroup::"

      - name: Determine deploy mode
        id: mode
        run: |
          # Get config values
          BUILD_DOCKER="${{ steps.config.outputs.build-docker }}"
          IS_PUSH="${{ github.event_name == 'push' }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          DEPLOY_BRANCHES="${{ inputs.deploy-branches }}"
          SKIP_CI="${{ inputs.skip-ci-in-jenkins }}"

          # Check if current branch matches any deploy pattern (supports wildcards)
          IS_DEPLOY_BRANCH="false"
          MATCHED_PATTERN=""
          IFS=',' read -ra PATTERNS <<< "$DEPLOY_BRANCHES"
          for pattern in "${PATTERNS[@]}"; do
            pattern=$(echo "$pattern" | xargs)  # trim whitespace
            # Use bash pattern matching (supports * wildcards)
            # e.g., staging-* matches staging-dev-foo, staging-qa, etc.
            if [[ "$CURRENT_BRANCH" == $pattern ]]; then
              IS_DEPLOY_BRANCH="true"
              MATCHED_PATTERN="$pattern"
              break
            fi
          done

          echo "Event: ${{ github.event_name }}"
          echo "Current Branch: $CURRENT_BRANCH"
          echo "Deploy Patterns: $DEPLOY_BRANCHES"
          echo "Is Deploy Branch: $IS_DEPLOY_BRANCH"
          if [ -n "$MATCHED_PATTERN" ]; then
            echo "Matched Pattern: $MATCHED_PATTERN"
          fi
          echo "Build Docker: $BUILD_DOCKER"
          echo "Skip CI in Jenkins: $SKIP_CI"

          # PRs do NOT trigger Jenkins - tests run in GitHub Actions
          if [ "$IS_PUSH" != "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "mode=Skipped (PR - tests run in GitHub Actions)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Push events - Docker build only on deploy branches with build_docker=true
          if [ "$IS_DEPLOY_BRANCH" == "true" ] && [ "$BUILD_DOCKER" == "true" ]; then
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
            if [ "$SKIP_CI" == "true" ]; then
              echo "mode=Docker Build (skip CI)" >> $GITHUB_OUTPUT
            else
              echo "mode=Docker Build (full CI)" >> $GITHUB_OUTPUT
            fi
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "mode=Skipped (not a deploy branch or build_docker=false)" >> $GITHUB_OUTPUT
          fi

      - name: Validate Jenkins configuration
        id: validate
        run: |
          if [ -z "${{ secrets.JENKINS_URL }}" ]; then
            echo "::warning::JENKINS_URL not configured - running in dry-run mode"
            echo "dry-run=true" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.dry-run }}" == "true" ]; then
            echo "Dry-run mode enabled"
            echo "dry-run=true" >> $GITHUB_OUTPUT
          else
            echo "dry-run=false" >> $GITHUB_OUTPUT
          fi

      - name: Log skipped trigger
        if: steps.mode.outputs.skip == 'true'
        run: |
          echo "## Jenkins Trigger (Skipped)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration from pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | \`${{ steps.config.outputs.odoo-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker | \`${{ steps.config.outputs.build-docker }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Edition | \`${{ steps.config.outputs.odoo-edition }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":information_source: Jenkins trigger skipped - ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY

          echo "::notice::Jenkins trigger skipped: ${{ steps.mode.outputs.mode }}"

      - name: Log Jenkins trigger (dry-run)
        if: steps.mode.outputs.skip != 'true' && steps.validate.outputs.dry-run == 'true'
        run: |
          echo "## Jenkins Trigger (Dry Run)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration from pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | \`${{ steps.config.outputs.odoo-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker | \`${{ steps.config.outputs.build-docker }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Edition | \`${{ steps.config.outputs.odoo-edition }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trigger Parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | \`${{ steps.mode.outputs.deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Patterns | \`${{ inputs.deploy-branches }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip CI in Jenkins | \`${{ inputs.skip-ci-in-jenkins }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.skip-ci-in-jenkins }}" == "true" ]; then
            echo ":zap: **Cost-efficient mode:** Jenkins will skip QA stages (already done in GitHub Actions)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo ":information_source: Dry-run mode - Jenkins was not triggered." >> $GITHUB_STEP_SUMMARY

          echo "::notice::Dry-run: Would trigger Jenkins (${{ steps.mode.outputs.mode }}) for ${{ github.repository }}@${{ github.ref_name }}"

      - name: Trigger Jenkins
        id: trigger
        if: steps.mode.outputs.skip != 'true' && steps.validate.outputs.dry-run == 'false'
        run: |
          echo "Triggering Jenkins: ${{ steps.mode.outputs.mode }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Deploy: ${{ steps.mode.outputs.deploy }}"
          echo "  Skip CI: ${{ inputs.skip-ci-in-jenkins }}"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ secrets.JENKINS_URL }}/generic-webhook-trigger/invoke" \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n '${{ secrets.JENKINS_USER }}:${{ secrets.JENKINS_TOKEN }}' | base64)" \
            -d '{
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "odoo_version": "${{ steps.config.outputs.odoo-version }}",
              "odoo_edition": "${{ steps.config.outputs.odoo-edition }}",
              "git_hosts": "${{ steps.config.outputs.git-hosts }}",
              "deploy": ${{ steps.mode.outputs.deploy }},
              "build_docker": ${{ steps.config.outputs.build-docker }},
              "skip_ci": ${{ inputs.skip-ci-in-jenkins }},
              "github_run_id": "${{ github.run_id }}",
              "github_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "event": "${{ github.event_name }}",
              "pr_number": "${{ github.event.pull_request.number || '' }}"
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [[ "$HTTP_CODE" != "200" && "$HTTP_CODE" != "201" ]]; then
            echo "::error::Jenkins trigger failed with HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

          echo "triggered=true" >> $GITHUB_OUTPUT

          echo "## Jenkins Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration from pyproject.toml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | \`${{ steps.config.outputs.odoo-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Docker | \`${{ steps.config.outputs.build-docker }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Edition | \`${{ steps.config.outputs.odoo-edition }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trigger Parameters" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | \`${{ steps.mode.outputs.deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip CI in Jenkins | \`${{ inputs.skip-ci-in-jenkins }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.skip-ci-in-jenkins }}" == "true" ]; then
            echo ":zap: **Cost-efficient mode:** Jenkins will skip QA stages (already done in GitHub Actions)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo ":rocket: Jenkins job started!" >> $GITHUB_STEP_SUMMARY

          echo "::notice::Jenkins triggered (${{ steps.mode.outputs.mode }}) for ${{ github.repository }}@${{ github.ref_name }}"
