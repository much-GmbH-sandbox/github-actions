# Auto-Format Workflow - Self-hosted pre-commit.ci Alternative
#
# Automatically fixes formatting issues on PRs and pushes the fix back to the branch.
# This replaces the paid pre-commit.ci service for private repositories.
#
# Features:
# - Runs Black formatter for Python code
# - Fixes trailing whitespace
# - Ensures files end with newline
# - Pushes fixes back to PR branch automatically
# - Skips fork PRs (no write access) with helpful message
# - Does NOT trigger infinite loops (uses GITHUB_TOKEN)
#
# Cost: ~1 minute per PR (only runs on PRs)
#
# Note: Concurrency should be set in the calling workflow, not here.

name: Auto Format

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version for formatters'
        required: false
        type: string
        default: '3.10'
      black-version:
        description: 'Black version (should match dev-requirements/base.txt)'
        required: false
        type: string
        default: '25.1.0'
    outputs:
      changes-made:
        description: 'Whether formatting changes were committed'
        value: ${{ jobs.format.outputs.changes-made }}

jobs:
  format:
    name: Auto-fix Formatting
    runs-on: ubuntu-latest
    # Only run on PRs from the same repo (not forks - can't push to fork branches)
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository

    permissions:
      contents: write
      pull-requests: read

    outputs:
      changes-made: ${{ steps.auto-commit.outputs.changes_detected }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          # CRITICAL: Checkout the PR branch, not the merge commit
          ref: ${{ github.head_ref }}
          # CRITICAL: Keep credentials for pushing
          persist-credentials: true
          # Full history not needed for formatting
          fetch-depth: 1

      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Black
        run: pip install -q black==${{ inputs.black-version }}

      - name: Run Black formatter
        run: |
          echo "::group::Black formatting"
          python -m black . --quiet 2>&1 || true
          echo "::endgroup::"

      - name: Fix trailing whitespace
        run: |
          echo "::group::Whitespace fixes"
          # Only process Python files to avoid breaking other file types
          find . -name "*.py" -type f ! -path "./.git/*" \
            -exec sed -i 's/[[:space:]]*$//' {} \;
          echo "::endgroup::"

      - name: Ensure files end with newline
        run: |
          find . -name "*.py" -type f ! -path "./.git/*" \
            -exec sh -c '[ -n "$(tail -c1 "$1")" ] && echo >> "$1"' _ {} \;

      - name: Commit and push changes
        id: auto-commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            style: auto-format code

            Applied by auto-format workflow.
          commit_options: '--no-verify'
          file_pattern: '*.py **/*.py'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_author: 'GitHub Actions <github-actions[bot]@users.noreply.github.com>'
          skip_dirty_check: false
          skip_fetch: true
          skip_checkout: true

      - name: Report results
        if: always()
        run: |
          if [ "${{ steps.auto-commit.outputs.changes_detected }}" == "true" ]; then
            echo "## Auto-Format Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":white_check_mark: **Formatting fixes applied and pushed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Commit: \`${{ steps.auto-commit.outputs.commit_hash }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Auto-Format Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":sparkles: **No formatting changes needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All Python files are already properly formatted." >> $GITHUB_STEP_SUMMARY
          fi

  # Separate job to handle fork PRs gracefully
  fork-notice:
    name: Fork PR Notice
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name != github.repository

    steps:
      - name: Post notice for fork PRs
        run: |
          echo "## Fork PR - Manual Formatting Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":warning: This PR is from a fork. Auto-formatting cannot push to fork branches." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please run the following commands locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install black" >> $GITHUB_STEP_SUMMARY
          echo "black ." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
